name: Branch Specific Actions

on:
  push:
    branches:
      - master
      - gh-pages

# 同一ブランチのデプロイ競合を防止
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ------------------------------------------------------------------
  # 1) master ブランチ = 本番環境へ反映
  # ------------------------------------------------------------------
  prod-deploy:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST_NAME }} >> ~/.ssh/known_hosts

      - name: Deploy to production server
        run: |
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.USER_NAME }}@${{ secrets.HOST_NAME }} \
              -o UserKnownHostsFile=/dev/null \
              "cd /var/www/html/pws/ && git pull origin master"

  # ------------------------------------------------------------------
  # 2) gh-pages ブランチ = GitHub Pages 用（artifact方式）
  # ------------------------------------------------------------------
  build-pages:
    if: github.ref == 'refs/heads/gh-pages'
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v3

      - name: Show last commit
        run: git --no-pager log -1 --stat

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y tidy pandoc

      - name: Build HTML by make.bash
        run: bash make.bash

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # make.bash の成果物ディレクトリに合わせてください（例: ./html や ./public 等）
          path: ./

  deploy-pages:
    needs: build-pages
    if: github.ref == 'refs/heads/gh-pages'
    runs-on: ubuntu-24.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
